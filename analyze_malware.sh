#!/bin/bash

# Vérification des arguments
if [ -z "$1" ]; then
    echo "Usage: $0 <fichier_a_analyser>"
    exit 1
fi

SAMPLE_PATH="$1"
SAMPLE_NAME=$(basename "$SAMPLE_PATH")
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_DIR="analysis/reports/${TIMESTAMP}_${SAMPLE_NAME}"

# Création des dossiers nécessaires
mkdir -p analysis/{samples,rules,reports}
mkdir -p "$REPORT_DIR"

# Copie du fichier à analyser dans le dossier samples si nécessaire
if [ "$SAMPLE_PATH" != "analysis/samples/$SAMPLE_NAME" ]; then
    cp "$SAMPLE_PATH" "analysis/samples/$SAMPLE_NAME"
fi

echo "[+] Démarrage de l'analyse pour: $SAMPLE_NAME"
echo "[+] Les rapports seront sauvegardés dans: $REPORT_DIR"

# 1. Analyse statique locale
echo "[+] Lancement de l'analyse statique..."
# Extraction des strings directement
strings "analysis/samples/$SAMPLE_NAME" > "$REPORT_DIR/strings_raw.txt" 2>/dev/null
# Analyse Binwalk dans le conteneur
docker-compose run --rm binwalk bash -c "cd /samples && binwalk -B -e -A $SAMPLE_NAME" > "$REPORT_DIR/binwalk_results.txt" 2>/dev/null
echo "[+] Analyse statique terminée"

# 2. Scan antivirus avec ClamAV
echo "[+] Lancement du scan ClamAV..."
docker-compose run --rm clamav clamscan --recursive --allmatch "/scan/$SAMPLE_NAME" > "$REPORT_DIR/clamav_results.txt" 2>/dev/null
echo "[+] Scan ClamAV terminé"

# Génération du rapport final
echo "[+] Génération du rapport final..."
{
    echo "=== Rapport d'analyse malware ==="
    echo "Fichier: $SAMPLE_NAME"
    echo "Date: $(date)"
    echo
    echo "1. Résultats Binwalk (analyse statique):"
    if [ -s "$REPORT_DIR/binwalk_results.txt" ]; then
        cat "$REPORT_DIR/binwalk_results.txt"
    else
        echo "Aucune signature binwalk détectée"
    fi
    echo
    echo "2. Chaînes suspectes extraites:"
    if [ -s "$REPORT_DIR/strings_raw.txt" ]; then
        echo "a) URLs et commandes:"
        grep -i -E "(http://|https://|ftp://|wget|curl|bash|exec|system|cmd|command|powershell)" "$REPORT_DIR/strings_raw.txt" 2>/dev/null || echo "Aucune trouvée"
        echo
        echo "b) Fichiers et chemins suspects:"
        grep -i -E "(/tmp/|/var/|\.exe|\.dll|\.sh|\.bat|\.ps1|/etc/|/usr/|/bin/)" "$REPORT_DIR/strings_raw.txt" 2>/dev/null || echo "Aucun trouvé"
        echo
        echo "c) Mots-clés suspects:"
        grep -i -E "(password|key|token|secret|admin|root|shell|hack|exploit|malware|virus)" "$REPORT_DIR/strings_raw.txt" 2>/dev/null || echo "Aucun trouvé"
    else
        echo "Aucune chaîne suspecte trouvée"
    fi
    echo
    echo "3. Résultats ClamAV:"
    if [ -s "$REPORT_DIR/clamav_results.txt" ]; then
        cat "$REPORT_DIR/clamav_results.txt"
    else
        echo "Aucune menace détectée par ClamAV"
    fi
} > "$REPORT_DIR/summary.txt"

echo "[+] Analyse terminée! Rapport complet disponible dans: $REPORT_DIR/summary.txt"
echo "[+] Pour consulter le rapport: cat $REPORT_DIR/summary.txt" 