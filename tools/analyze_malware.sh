#!/bin/bash

# Variables
SAMPLE_PATH="$1"
SAMPLE_NAME=$(basename "$SAMPLE_PATH")
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_DIR="analysis/reports/${TIMESTAMP}_${SAMPLE_NAME}"

# Création du dossier de rapport
mkdir -p "$REPORT_DIR"

echo "[+] Démarrage de l'analyse pour: $SAMPLE_NAME"
echo "[+] Les rapports seront sauvegardés dans: $REPORT_DIR"

# 1. Analyse YARA
echo "[+] Lancement de l'analyse YARA..."
docker-compose run --rm yara yara -r /rules/* "/samples/$SAMPLE_NAME" > "$REPORT_DIR/yara_results.txt"
echo "[+] Analyse YARA terminée"

# 2. Analyse Binwalk
echo "[+] Lancement de l'analyse Binwalk..."
docker-compose run --rm binwalk binwalk -B -e "/samples/$SAMPLE_NAME" > "$REPORT_DIR/binwalk_results.txt"
# Extraction des chaînes
docker-compose run --rm binwalk strings "/samples/$SAMPLE_NAME" > "$REPORT_DIR/strings_results.txt"
echo "[+] Analyse Binwalk terminée"

# 3. Analyse Volatility (si c'est un dump mémoire)
if file "$SAMPLE_PATH" | grep -i "memory"; then
    echo "[+] Fichier identifié comme dump mémoire, lancement de Volatility3..."
    docker-compose run --rm volatility3 vol.py -f "/memory/$SAMPLE_NAME" windows.pslist > "$REPORT_DIR/volatility_processes.txt"
    docker-compose run --rm volatility3 vol.py -f "/memory/$SAMPLE_NAME" windows.netscan > "$REPORT_DIR/volatility_network.txt"
    docker-compose run --rm volatility3 vol.py -f "/memory/$SAMPLE_NAME" windows.malfind > "$REPORT_DIR/volatility_malfind.txt"
    echo "[+] Analyse Volatility terminée"
fi

# Génération du rapport final
echo "[+] Génération du rapport final..."
cat > "$REPORT_DIR/summary.txt" << EOF
=== Rapport d'analyse malware ===
Fichier: $SAMPLE_NAME
Date: $(date)

1. Résultats YARA:
$(cat "$REPORT_DIR/yara_results.txt")

2. Résultats Binwalk:
$(cat "$REPORT_DIR/binwalk_results.txt")

3. Chaînes extraites (top 20 plus pertinentes):
$(grep -i -E "http|cmd|exe|dll|registry|key|password" "$REPORT_DIR/strings_results.txt" | head -20)

EOF

if [ -f "$REPORT_DIR/volatility_processes.txt" ]; then
    cat >> "$REPORT_DIR/summary.txt" << EOF

4. Analyse mémoire (Volatility3):
- Processus suspects:
$(cat "$REPORT_DIR/volatility_processes.txt")

- Connexions réseau:
$(cat "$REPORT_DIR/volatility_network.txt")

- Code injecté potentiel:
$(cat "$REPORT_DIR/volatility_malfind.txt")
EOF
fi

echo "[+] Analyse terminée! Rapport complet disponible dans: $REPORT_DIR/summary.txt" 